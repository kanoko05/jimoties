<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ジモティーズ - カート</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.12/dist/vuetify.min.css" rel="stylesheet">
</head>
<body>
  <div id="app">
    <v-app>
      <v-app-bar color="#7b9e7a" dark dense>
        <v-toolbar-title style="font-size: 20px;">ジモティーズ</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-btn text color="#fff" @click="goHome">ホーム</v-btn>
        <v-btn text color="#fff" @click="logout">ログアウト</v-btn>
      </v-app-bar>
      
      <v-main>
        <v-container class="v-container-main" style="background-color: white;">
          <v-data-table
            :headers="headers"
            :items="desserts"
            :items-per-page="itemsPerPage"
            item-key="id"
            class="elevation-1"
            :disable-sort="true"
            hide-default-footer
          >
            <template v-slot:top>
              <v-btn icon @click="confirmDelete">
                <v-icon color="red">mdi-delete</v-icon>
              </v-btn>
            </template>

            <template v-slot:item="{ item }">
              <tr>
                <td>
                  <v-checkbox
                    v-model="item.isSelected"
                    :value="item"
                    @change="updateSelectedItems(item)"
                  ></v-checkbox>
                </td>
                <td>
                  <img :src="item.Item_image || 'https://via.placeholder.com/100'" alt="商品画像" width="100" />
                </td>
                <td>
                  <a href="#" @click.prevent="goToItemDetail(item.Item_name)" style="cursor: pointer; color: #7b9e7a;">
                    {{ item.Item_name }}
                  </a>
                </td>
                <td>{{ item.Item_prefecture }}</td>
                <td>
                  <v-btn icon @click="updateItemQuantity(item, -1)">
                    <v-icon>mdi-minus</v-icon>
                  </v-btn>
                  <span>{{ item.Item_num }}</span>
                  <v-btn icon @click="updateItemQuantity(item, 1)">
                    <v-icon>mdi-plus</v-icon>
                  </v-btn>
                </td>
                <td>{{ item.Item_price }}円</td>
              </tr>
            </template>

            <template v-slot:body.append>
              <tr>
                <td colspan="6" class="total-amount-large" style="text-align: center;">合計金額: {{ totalPrice }} 円</td>
              </tr>
            </template>
          </v-data-table>
        </v-container>

        <v-container class="text-center" style="padding: 16px;">
          <v-btn class="custom-back-btn" style="background-color: red; color: white; margin-right: 10px;" @click="goHome">
            ホームに戻る
          </v-btn>
          <v-btn class="custom-purchase-btn" style="background-color: #7b9e7a; color: white;" @click="goOrder">
            ご購入手続きに進む
          </v-btn>
        </v-container>
      </v-main>

      <v-footer class="footer">
        &copy; 2024 ジモティーズ. All rights reserved.
        <v-btn text class="admin-login-btn" @click="goAdminLogin">管理者はこちらから</v-btn>
      </v-footer>
    </v-app>
  </div>

  <style>
    /* ヘッダーと他の部分のスタイル調整 */
    .v-app-bar {
      max-height: 64px; /* ヘッダーの高さを調整 */
    }
    .header {
      background-color: #7b9e7a;
      color: white;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-title {
      font-family: 'serif';
      font-size: 24px;
      font-weight: bold;
    }
    .footer {
      background-color: #e0f0e6;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #7b9e7a;
      font-size: 14px;
      height: 75px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.12/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data() {
        return {
          headers: [
            { text: '', value: 'isSelected' },
            { text: '商品画像', value: 'img' },
            { text: '商品名', value: 'name' },
            { text: '産地', value: 'prefecture' },
            { text: '個数', value: 'num' },
            { text: '金額', value: 'price' }
          ],
          itemsPerPage: 10,
          desserts: [],
          selectedItems: [],
          totalPrice: 0,
          userID: null,
        };
      },

      mounted() {
        const storedUserID = sessionStorage.getItem('user_ID');
        if (storedUserID) {
            this.userID = parseInt(storedUserID, 10);
            this.fetchshoplist();
        } else {
            alert('ユーザーIDが指定されていません。ログインが必要です。');
            window.location.href = 'UserLogin.html';
        }
      },

      methods: {
        async fetchshoplist() {
          const param = { User_ID: this.userID };
          try {
              const response = await axios.post('https://m3h-minaki-jimoties.azurewebsites.net/api/ListShoplist', param);
              if (response.data && response.data.ShoplistList) {
                  this.desserts = response.data.ShoplistList;
                  const fetchItemData = this.desserts.map(async item => {
                      const param2 = { Item_ID: item.Item_ID };
                      const response2 = await axios.post('https://m3h-minaki-jimoties.azurewebsites.net/api/SearchItemId', param2);
                      if (response2.data && response2.data.ItemTableList && response2.data.ItemTableList.length > 0) {
                          const itemData = response2.data.ItemTableList[0];
                          item.Item_name = itemData.Item_name || "不明";
                          item.Item_prefecture = itemData.Item_prefecture || "不明";
                          item.Item_price = itemData.Item_price || 0;
                          item.Item_image = itemData.Item_image || "https://via.placeholder.com/100";
                      }
                  });
                  await Promise.all(fetchItemData);
                  this.calculateTotalPrice();
              }
          } catch (error) {
              console.error('データの取得に失敗しました:', error);
          }
        },

        updateItemQuantity(item, quantityChange) {
          const newQuantity = item.Item_num + quantityChange;
          if (newQuantity <= 0) {
            alert('数量は1以上でなければなりません。');
            return;
          }
          const params = {
            user_ID: this.userID,
            item_ID: item.Item_ID,
            item_num: newQuantity,
          };
          axios.post('https://m3h-nishizawa-jimotiesapi.azurewebsites.net/api/UpdateItemShopList', params)
            .then(() => {
              item.Item_num = newQuantity;
              this.calculateTotalPrice();
            })
            .catch(() => {
              alert('数量の更新に失敗しました。もう一度お試しください。');
            });
        },

        calculateTotalPrice() {
          this.totalPrice = this.desserts.reduce((acc, item) => acc + (item.Item_price * item.Item_num), 0);
        },

        goHome() {
          window.location.href = 'index.html';
        },

        goToItemDetail(itemName) {
          window.location.href = `ItemDetail.html?name=${encodeURIComponent(itemName)}`;
        },

        goOrder() {
          window.location.href = 'Order.html';
        },

        goAdminLogin() {
          window.location.href = 'EmployeeLogin.html';
        },

        logout() {
          sessionStorage.removeItem('user_ID');
          window.location.href = `UserLogin.html`;
        },
      },

      watch: {
        desserts: 'calculateTotalPrice'
      }
    });
  </script>
</body>
</html>


