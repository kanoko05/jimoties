<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ジモティーズ - カート</title>
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.12/dist/vuetify.min.css" rel="stylesheet">
</head>
<body>
  <div id="app">
    <v-app style="background-color: white;">
      <div class="header">
        <div class="header-left">
          <div class="header-title">
            <v-icon class="mdi-icon">mdi-home-city-outline</v-icon>
            ジモティーズ
          </div>
        </div>
        <div class="header-right">
          <v-btn text color="#7b9e7a" @click="goHome">ホーム</v-btn>
          <v-btn @click="logout" text color="#7b9e7a">ログアウト</v-btn>
        </div>
      </div>
      <!-- 題名バー -->
      <v-app-bar color="#7b9e7a" dark dense class="custom-app-bar">
        <v-toolbar-title style="font-size: 20px;">カート</v-toolbar-title>
      </v-app-bar>
      <br><br>
      <!-- メインコンテンツ -->
      <v-main>
        <v-container class="v-container-main" style="background-color: white;">
          <v-data-table
            :headers="headers"
            :items="desserts"
            :items-per-page="itemsPerPage"
            item-key="id"
            class="elevation-1"
            :disable-sort="true"
            hide-default-footer
          >
            <template v-slot:top>
              <v-btn icon @click="confirmDelete">
                <v-icon color="red">mdi-delete</v-icon>
              </v-btn>
            </template>

            <template v-slot:item="{ item }">
              <tr>
                <td>
                  <v-checkbox
                    v-model="item.isSelected"
                    :value="item"
                    @change="updateSelectedItems(item)"
                  ></v-checkbox>
                </td>
                <td>
                  <img :src="item.Item_image || 'https://via.placeholder.com/100'" alt="商品画像" width="100" />
                </td>
                <td>
                  <!-- 商品名をクリックすると商品詳細ページに遷移 -->
                  <a href="#" @click.prevent="goToItemDetail(item.Item_name)" style="cursor: pointer; color: #7b9e7a;">
                    {{ item.Item_name }}
                  </a>
                </td>
                <td>{{ item.Item_prefecture }}</td>
                <td>
                  <v-btn icon @click="updateItemQuantity(item, -1)">
                    <v-icon>mdi-minus</v-icon>
                  </v-btn>
                  <span>{{ item.Item_num }}</span>
                  <v-btn icon @click="updateItemQuantity(item, 1)">
                    <v-icon>mdi-plus</v-icon>
                  </v-btn>
                </td>
                <td>{{ item.Item_price }}円</td>
              </tr>
            </template>

            <!-- カスタムフッターで合計金額を表示 -->
            <template v-slot:body.append>
              <tr>
                <td colspan="6" class="total-amount-large" style="text-align: center;">合計金額: {{ totalPrice }} 円</td>
              </tr>
            </template>
          </v-data-table>
        </v-container>

        <!-- 合計金額のバーの下にボタンを追加 -->
        <v-container class="text-center" style="padding: 16px;">
          <v-btn class="custom-back-btn" style="background-color: red; color: white; margin-right: 10px;" @click="goHome">
            ホームに戻る
          </v-btn>
          <v-btn class="custom-purchase-btn" style="background-color: #7b9e7a; color: white;" @click="goOrder">
            ご購入手続きに進む
          </v-btn>
        </v-container>
      </v-main>

      <!-- フッター -->
      <v-footer class="footer">
        &copy; 2024 ジモティーズ. All rights reserved.
        <v-btn text class="admin-login-btn" @click="goAdminLogin">管理者はこちらから</v-btn>
      </v-footer>
    </v-app>
  </div>

  <style>
    /* Styles remain the same */
  </style>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.12/dist/vuetify.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      data() {
        return {
          headers: [
            { text: '', value: 'isSelected' }, // チェックボックス用
            { text: '商品画像', value: 'img' },
            { text: '商品名', value: 'name' },
            { text: '産地', value: 'prefecture' },
            { text: '個数', value: 'num' },
            { text: '金額', value: 'price' }
          ],
          itemsPerPage: 10,
          desserts: [], // 初期値は空の配列
          selectedItems: [], // 選択されたアイテムの配列
          totalPrice: 0, // 合計金額を保持する変数
          userID: null, // 初期値をnullに設定してデフォルトを持たせない
        };
      },

      mounted() {
        const storedUserID = sessionStorage.getItem('user_ID');
        if (storedUserID) {
            this.userID = parseInt(storedUserID, 10);
            console.log('取得したユーザーID:', this.userID);
            this.fetchshoplist();
        } else {
            alert('ユーザーIDが指定されていません。ログインが必要です。');
            console.error('セッションストレージにユーザーIDが存在しません。');
            window.location.href = 'UserLogin.html';
        }
      },

      methods: {
        async fetchshoplist() {
          console.log("データ取得開始：", "User_ID:", this.userID);
          const param = { User_ID: this.userID };

          try {
              console.log(`APIに送信するリクエストパラメータ:`, param);
              const response = await axios.post('https://m3h-minaki-jimoties.azurewebsites.net/api/ListShoplist', param, {
                  headers: { 'Cache-Control': 'no-cache' }
              });

              if (response.data && response.data.ShoplistList) {
                  this.desserts = response.data.ShoplistList; 
                  const fetchItemData = this.desserts.map(async item => {
                      const param2 = { Item_ID: item.Item_ID };
                      try {
                          const response2 = await axios.post('https://m3h-minaki-jimoties.azurewebsites.net/api/SearchItemId', param2);
                          if (response2.data && response2.data.ItemTableList && response2.data.ItemTableList.length > 0) {
                              const itemData = response2.data.ItemTableList[0];
                              item.Item_name = itemData.Item_name || "不明";
                              item.Item_prefecture = itemData.Item_prefecture || "不明";
                              item.Item_price = itemData.Item_price || 0;
                              item.Item_image = itemData.Item_image || "https://via.placeholder.com/100";
                          }
                      } catch (error) {
                          console.error(`Item_ID ${item.Item_ID} のデータ取得に失敗しました:`, error);
                      }
                  });
                  await Promise.all(fetchItemData);
                  this.calculateTotalPrice();
              } else {
                  console.error('レスポンスの形式が予想外です:', response);
              }
          } catch (error) {
              console.error('データの取得に失敗しました:', error);
          }
        },

        async updateItemQuantity(item, quantityChange) {
          const newQuantity = item.Item_num + quantityChange;
          if (newQuantity <= 0) {
            alert('数量は1以上でなければなりません。');
            return;
          }

          const params = {
            user_ID: this.userID,
            item_ID: item.Item_ID,
            item_num: newQuantity,
          };

          try {
            const response = await axios.post('https://m3h-nishizawa-jimotiesapi.azurewebsites.net/api/UpdateItemShopList', params);
            if (response.status === 200) {
              item.Item_num = newQuantity;
              this.calculateTotalPrice();
            } else {
              alert('数量の更新に失敗しました。もう一度お試しください。');
            }
          } catch (error) {
            console.error('数量の更新エラー:', error);
            alert('数量の更新に失敗しました。もう一度お試しください。');
          }
        },

        confirmDelete() {
          if (this.selectedItems.length === 0) {
            alert('削除するアイテムを選択してください。');
            return;
          }
          if (confirm('選択した商品を削除しますか？')) {
            this.deleteSelected();
          }
        },

        async deleteSelected() {
          const functionUrl = 'https://m3h-nishizawa-jimotiesapi.azurewebsites.net/api/DeleteItemShopList';
          try {
            for (let item of this.selectedItems) {
              const response = await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  user_ID: this.userID,
                  item_ID: item.Item_ID
                })
              });

              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }

              const result = await response.json();
              if (result.status === 'Success') {
                this.desserts = this.desserts.filter(dessert => dessert.Item_ID !== item.Item_ID);
                this.desserts = [...this.desserts];
                alert(`${item.Item_name}が削除されました。`);
              } else {
                alert('削除に失敗しました。');
              }
            }
            this.selectedItems = [];
            this.calculateTotalPrice();
          } catch (error) {
            console.error('削除中にエラーが発生しました:', error);
            alert('削除中にエラーが発生しました。');
          }
        },

        updateSelectedItems(item) {
          if (item.isSelected) {
            this.selectedItems.push(item);
          } else {
            const index = this.selectedItems.indexOf(item);
            if (index > -1) {
              this.selectedItems.splice(index, 1);
            }
          }
        },

        calculateTotalPrice() {
          this.totalPrice = this.desserts.reduce((acc, item) => acc + (item.Item_price * item.Item_num), 0);
        },

        goHome() {
          window.location.href = 'index.html';
        },

        goToItemDetail(itemName) {
          window.location.href = `ItemDetail.html?name=${encodeURIComponent(itemName)}`;
        },

        goOrder() {
          window.location.href = 'Order.html';
        },

        goAdminLogin() {
          window.location.href = 'EmployeeLogin.html';
        },

        logout() {
          sessionStorage.removeItem('user_ID');
          window.location.href = `UserLogin.html`;
        },
      },

      watch: {
        desserts: 'calculateTotalPrice'
      }
    });
  </script>
</body>
</html>

